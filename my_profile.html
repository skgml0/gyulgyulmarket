<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <link rel="stylesheet" href="./src/style/reset.css">
    <link rel="stylesheet" href="./src/style/my_profile.css">
    <link rel="stylesheet" href="./src//style/style_module.css">
   
</head>
<body>
    <main>
        <section class="main-profile">
            <div class="profile-conf">
                <div class="followers">
                    <p>2133</p>
                    <small>followers</small>
                </div>
                <img src="" alt="" class="profile-img">
                <div class="followings">
                    <p>128</p>
                    <small>followings</small>
                </div>
            </div>
            <h2 class="profile-accountname">애월읍 위니브 감귤농장</h2>
            <small class="profile-username">@ weniv_Mandarin</small>
            <p class="profile-intro">애월읍 감귤 전국 배송, 귤따기 체험, 감귤 농장</p>
            <div class="profile-btns">
                <a href="">프로필 수정</a>
                <a href="">상품 등록</a>
            </div>                
        </section>

        <section class="sect-sell">
            <h3>판매 중인 상품</h3>
            <ul class="sell-list">
                <li>
                    <img src="" alt="">
                    <p>한라봉</p>
                    <em>34,000원</em>
                </li>
            </ul>
        </section>

        <article class="sect-post">
            <button class="post-form-album"><img src="src/images/icon/icon-post-album-off.png" alt=""></button> 
            <button class="post-form-list"><img src="src/images/icon/icon-post-list-on.png" alt=""></button>
            <ul>
                <li class="post-box-list">
                    <img src="" alt="">
                    <section class="post-content">
                        <h4>애월읍 위니브 감귤농장</h4>
                        <small>@ weniv_Mandarin</small>
                        <p>옷을 인생을 그러므로 없으면 것은 이상은 것은 우리의 위하여, 뿐이다. 이상의 청춘의 뼈 따뜻한 그들의 그와 약동하다. 대고, 못할 넣는 풍부하게 뛰노는 인생의 힘있다.</p>
                        <img src="" alt="" class="post-img">
                        <button><img src="" alt=""> 58</button>
                        <button><img src="" alt=""> 12</button>
                        <p class="post-date">2020년 10월 21일</p>
                    </section>
                </li>
            </ul>

            <article class="post-box-album">
                <a href="#none"><img src="" alt=""></a>

            </article>
        </article>

        <nav class="nav-tab-menu">
            <ul class="nav-tab-menu__list">
              <li class="nav-tab-menu__item">
                <a
                  href="home.html"
                  class="nav-tab-menu__wrapper nav-tab-menu__home nav-tab-menu__home--active"
                >
                  <p class="nav-tab-menu__txt nav-tab-menu__txt">홈</p>
                </a>
              </li>
              <li class="nav-tab-menu__item">
                <a
                  href="chatroom.html"
                  class="nav-tab-menu__wrapper nav-tab-menu__chat"
                >
                  <p class="nav-tab-menu__txt">채팅</p>
                </a>
              </li>
              <li class="nav-tab-menu__item">
                <a
                  href="upload.html"
                  class="nav-tab-menu__wrapper nav-tab-menu__post"
                >
                  <p class="nav-tab-menu__txt">게시물 작성</p>
                </a>
              </li>
              <li class="nav-tab-menu__item">
                <a
                  href="profile.html"
                  class="nav-tab-menu__wrapper nav-tab-menu__profile active"
                >
                  <p class="nav-tab-menu__txt active">프로필</p>
                </a>
              </li>
            </ul>
          </nav>
    </main>


    <script>
        console.log(document.cookie)
        let JWT_TOKEN =document.cookie.split(" ").filter((key)=> {
            if(key.match('gyulgyul-token') !==null) return key
        }).join('').replace('gyulgyul-token=','');

        console.log(JWT_TOKEN)
        
        const myAccountName = localStorage.getItem('accountname')
        async function initProfile() {
            const res = await fetch(`http://146.56.183.55:5050/profile/${myAccountName}`,{
                method: "get",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization" : `Bearer ${JWT_TOKEN}`                   
                }
            });
            const json = await res.json()
            const profileData = json.profile
            console.log(profileData)

            document.querySelector('.profile-img').src = profileData.image;
            document.querySelector('.followers p').textContent = profileData.followerCount;
            document.querySelector('.followings p').textContent = profileData.followingCount;
            document.querySelector('.profile-accountname').textContent = profileData.accountname;
            document.querySelector('.profile-username').textContent = profileData.username;
            document.querySelector('.profile-intro').textContent = profileData.intro;

            getProductData()
        }

        //판매 중인 상품 
        async function getProductData() {
            const data = await fetch(
            `http://146.56.183.55:5050/product/${myAccountName}`,
            {
                method: 'get',
                headers: {
                    "Content-Type": "application/json",
                    "Authorization" : `Bearer ${JWT_TOKEN}`                   
                }
            },
            );
            let product = await data.json();
            let productData = product.product;
            console.log(productData);
        
            const productchild = document.querySelector('.sell-list');
            productchild.innerHTML = productData.map((item) => {
            return `
                <li data-id="${item.id}">
                    <img src="${item.itemImage}" alt="">
                    <p>${item.itemName}</p>
                    <em>${item.price}</em>
                </li>
                `;
            }).join('');
        
            [...productchild.children].forEach((child) => {
            child.addEventListener('click', ({ currentTarget }) => {
                console.log(currentTarget.dataset);
            });
            });
        }

      //게시글
        async function feed() {
            const res = await fetch(
            `${BASE_URL}/post/${urlQuery}/userpost`,
            {
                method: 'get',
                headers: {
                Authorization: `Bearer ${Auth.getToken()}`,
                'Content-Type': 'application/json',
                },
            },
            );
            const feedjson = await res.json();
            console.log(feedjson);
            console.log(feedjson.post);
            console.log('0000');
            const feedchild = document.querySelector('.post-list');
            const albumchild = document.querySelector('.post-album')
            feedchild.innerHTML = feedjson.post.map((item) => {
            console.log(item)
            let date = item.createdAt.split('-');
            let d_year = date[0];
            let d_month = date[1];
            let d_day = date[2].slice(0, 2);
            const imgparse = item.image ? item.image.split(',') : [''];
            
            return `
                <li class="post-list-item">
                <img
                    src="${item.author.image}"
                    class="post-profile-img"
                />
                <div>
                    <div class="post-profile-text">
                    <strong class="post-writer">${item.author.username}</strong>
                    <span class="post-writer-id">@ ${item.author.accountname}</span>
                    </div>
                    <p class="post-text">
                    ${item.author.intro}
                    </p>
                    <!-- <img src="${imgparse[0]}" onerror="this.style.visibility='hidden';" class="post-img" />-->
                    <div class="upload-slide-wrap">
                    <ul class="upload-slide">
                        ${imgparse.map((i, idx) => {
                        return `
                            <li class="upload-slide-item">
                            <img
                                src=${i}
                                alt=""
                                class="upload-slide-img">
                            <button id=${idx} class="upload-slide-img-delete">X</button>
                            </li>
                        `;
                        }).join('')}
                    </ul>
                    <div class="slide-arrow-left">
                        <i class="fas fa-chevron-left"></i>
                    </div>
                    <div class="slide-arrow-right">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                    <ul class="slide-points"></ul>
                    </div>
                    <div class="post-utils">
                    <button class="btn-like">
                        <img src="src/images/icon/icon-heart.png" alt="좋아요 수" />
                    </button>
                    <span class="count-like">${item.heartCount}</span>
                    <button class="btn-comment">
                        <img
                        src="src/images/icon/icon-message-circle.png"
                        alt="댓글 수"
                        />
                    </button>
                    <span class="count-comment">${item.comments.length}</span>
                    </div>
                    <span class="post-date">${d_year}년 ${d_month}월 ${d_day}일</span>
                </div>
                <button class="btn-post-menu">
                    <img
                    src="src/images/icon/s-icon-more-vertical.png"
                    alt="게시글 메뉴 열기"
                    />
                </button>
                </li>
                `
            }).join('');
            
            const imgs = feedjson.post.map(feed => feed.image ? feed.image.split(',') : ['']);

            document.querySelectorAll('.upload-slide-wrap').forEach((feed, idx) => {
                new Slider(feed, imgs[idx]);
            })

            albumchild.innerHTML = feedjson.post.map((item)=> {
                const imgparse = item.image ? item.image.split(',') : [''];
                if(!!item.image) {
                return`
                    <li class="post-album-item more-photos">
                    <img
                        src="${imgparse[0]}"
                        class="post-album-img"
                        onerror="this.style.display='none';"
                    />
                    ${imgparse.length>1 ? `<div class="post-album-item more-photos addPhotos"></div>`:``}
                    </li>
                `
                }
            }).join('')

        }

        initProfile()
    </script>
</body>
</html>